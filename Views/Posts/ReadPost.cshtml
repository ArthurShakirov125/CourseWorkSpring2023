@using CourseWorkSpring2023.Models.IndexViewModel;
@using CourseWorkSpring2023.Models.Moderator;
@model PostViewModel

<div class="custom-post_strip">
    <div>
        <div>@Model.Header</div>
        <div>
            111
        </div>
    </div>
    <div>
        <div>@Html.ActionLink(@Model.Author.NickName, "UserPage", "User", new { userName = Model.Author.UserName})</div>
        <div>@Html.ActionLink("Закрыть", "Index", "Posts")</div>
    </div>
</div>

<div class="custom-posts_container">
    <div class="custom-post_header">
        <h1>@Model.Header</h1>
        <div>@Model.Posted</div>
</div>

    <div class="custom-post_text">
        @Model.ProcessedText
    </div>

    <textarea id="text_input"></textarea>
    <p>Комментариев - @Model.CommentsCount</p>

    @if(Model.ActiveUser == null){
        <a class="custom-red_btn custom-leave_message_unsigned" asp-area="Identity" asp-page="/Account/Register">Оставить комментарий</a>
    }
    else{
        @(await Html.RenderComponentAsync<CourseWorkSpring2023.BlazorComponents.
                        CommentBtn>(RenderMode.ServerPrerendered,new { PostId = Model.Id, UserName = User.Identity.Name}))
    }

    <div class="comment-section">
        @if(Model.Comments.Any()){
            @foreach (var comment in Model.Comments)
            {
                <div class="comment content" id="@comment.Id">
                    @if (User.IsInRole("Moderator"))
                        //@await Component.InvokeAsync("ModeratorTools", new { ContentType = "comment", Id = comment.Id})
                        @(await Html.RenderComponentAsync<CourseWorkSpring2023.BlazorComponents.
                        ModeratorTools>(RenderMode.ServerPrerendered,new { ContentType = "comment", Id = comment.Id, IsHidden = comment.IsHidden}))

                    <h4>@Html.ActionLink(comment.User.NickName, "UserPage", "Home", new { userName = comment.User.UserName})</h4>
                    <p>@comment.ProcessedText</p>
                    <p>Рейтинг:</p>
                    <p>isHidden  -  @comment.IsHidden</p>
                    <p class="rating">@comment.Rating</p>
            
                @if(Model.ActiveUser == null)
                {
                    <a class="btn btn-secondary" asp-area="Identity" asp-page="/Account/Register">+</a>
                    <a class="btn btn-secondary" asp-area="Identity" asp-page="/Account/Register">-</a>
                }
                else
                {
                    @if (Model.UpvotedCommentsIds.Contains(comment.Id))
                    {
                        <button class="btn btn-warning likeBtn"   data-isPicked="true"  data-Id=@comment.Id data-action="remove_upvote">+</button>
                        <button class="btn btn-secondary dislikeBtn" data-isPicked="false" data-Id=@comment.Id data-action="downvote_and_remove_upvote">-</button>
                    }
                    else if (Model.DownvotedCommentsIds.Contains(comment.Id))
                    {
                        <button class="btn btn-secondary likeBtn" data-isPicked="false" data-Id=@comment.Id data-action="upvote_and_remove_downvote">+</button>
                        <button class="btn btn-warning dislikeBtn"   data-isPicked="true" data-Id=@comment.Id data-action="remove_downvote">-</button>
                    }
                    else
                    {
                        <button class="btn btn-secondary likeBtn" data-isPicked="false" data-Id=@comment.Id data-action="upvote">+</button>
                        <button class="btn btn-secondary dislikeBtn" data-isPicked="false" data-Id=@comment.Id data-action="downvote">-</button>
                    }
                }
                </div>
            }
        }else{
            <div class="no-comments">
                <p>Комментариев пока нету</p>
            </div>
        }    
        </div>
</div>


@section scripts{
    <script src="~/lib/Trumbowyg/dist/trumbowyg.min.js"></script>
    <script src="~/lib/Trumbowyg/dist/langs/ru.js"></script>
    <script src="~/js/RichTextArea/rich_text_area.js"></script>
    <script src="~/js/Blazor/BlazorHandler.js"></script>
}

@section AddToHead{
    <link rel="stylesheet" href="~/lib/Trumbowyg/dist/ui/trumbowyg.min.css">
    <link rel="stylesheet" href="~/css/post_page.css"/>
}